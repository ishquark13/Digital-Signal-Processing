/*
 * Lab.6 part 1:
 * Making an real time DSP FIR filter with the following parameters:
 * LPF, Pass Band (3 dB ripple) 0-900 Hz, Stop Band (-40 dBs) 3K-22K, F_sampling = 44 KHz;
 */

#include <DSP28x_Project.h>
#include "OneToOneI2CDriver.h"
#include <DSP2833x_Xintf.h>
#include<DSP2833x_XIntrupt.h>
#include "timer.h"
#include "analogToDigitalConverter.h"
#include "digitalToAnalogConverter.h"
#include "DSP2833x_CpuTimers.h"
#include <DSP2833x_SysCtrl.h>
#include "audioCntrl.h"
#include "Sram.h"
#include "digitalToAnalogConverter.h"
#include "hammingWindow.h"


/*

FIR filter designed with
http://t-filter.appspot.com

sampling frequency: 44100 Hz

* 0 Hz - 900 Hz
  gain = 1
  desired ripple = 3 dB
  actual ripple = 1.191066035841248 dB

* 3000 Hz - 22000 Hz
  gain = 0
  desired attenuation = -40 dB
  actual attenuation = -45.929675482422645 dB

*/

#define FILTER_LP_TAP_NUM 26
#define FILTER_HP_TAP_NUM 29
#define FILTER_BP_TAP_NUM 160
#define FILTER_LP_72K     42
#define FILTER_HP_72K     38
int j = 0;
float bufferForFilters[256];
float filter_taps_LP[] = {0.00868719587227721,0.00978799761231168,0.0146398731573921,0.0204326085630858,0.0270403726046008,0.0342172002966012,0.0416889063602066,0.0490901455897425,0.0560421502947487,0.0621657775713653,0.0671130040199619,0.0705916329807173,0.0723872586340389,0.0723872586340389,0.0705916329807173,0.0671130040199619,0.0621657775713653,0.0560421502947487,0.0490901455897425,0.0416889063602066,0.0342172002966012,0.0270403726046008,0.0204326085630858,0.0146398731573921,0.00978799761231168,0.00868719587227721};
float filter_taps_BP[] = {0.00798012105183658,0.00196767992995259,0.00219049844531026,0.00241639010134931,0.00263856687971078,0.00285676006224006,0.00306488930435805,0.00326423094682146,0.00344709632934101,0.00361216177612001,0.00374564538082849,0.00384789398727738,0.00391185612453058,0.00395317904051374,0.00392689899373749,0.00385682559315105,0.00373502528613601,0.00354613163519810,0.00329693414236480,0.00297484232257631,0.00258422224047808,0.00211839498472640,0.00158151717594704,0.000967579829080463,0.000280981933850467,-0.000478187296722703,-0.00130010802148164,-0.00219014191228400,-0.00313696282278568,-0.00413192937517582,-0.00517195565428610,-0.00624287483621639,-0.00733829839744072,-0.00844463927719365,-0.00955081270127063,-0.0106423573021051,-0.0117076450753931,-0.0127327050271981,-0.0137029815755800,-0.0146029440118744,-0.0154214061655387,-0.0161444427075606,-0.0167566526832823,-0.0172495359749771,-0.0176087274142592,-0.0178265699074701,-0.0178936246442981,-0.0178026645461269,-0.0175477517144632,-0.0171253388243203,-0.0165343454357570,-0.0157732077433538,-0.0148438628095767,-0.0137504532917932,-0.0124994364078024,-0.0110962566613730,-0.00955288978065314,-0.00787838919860091,-0.00608708619802821,-0.00419343056398838,-0.00221289901673831,-0.000162665340344205,0.00193910405773474,0.00407228293231474,0.00621836776450905,0.00835702349426307,0.0104676049851028,0.0125296147457404,0.0145238778190747,0.0164299820956351,0.0182299819517749,0.0199060023742479,0.0214403360080317,0.0228189853354546,0.0240274023231811,0.0250541883588446,0.0258875234780944,0.0265203871485025,0.0269460217836689,0.0271598341278188,0.0271598341278188,0.0269460217836689,0.0265203871485025,0.0258875234780944,0.0250541883588446,0.0240274023231811,0.0228189853354546,0.0214403360080317,0.0199060023742479,0.0182299819517749,0.0164299820956351,0.0145238778190747,0.0125296147457404,0.0104676049851028,0.00835702349426307,0.00621836776450905,0.00407228293231474,0.00193910405773474,-0.000162665340344205,-0.00221289901673831,-0.00419343056398838,-0.00608708619802821,-0.00787838919860091,-0.00955288978065314,-0.0110962566613730,-0.0124994364078024,-0.0137504532917932,-0.0148438628095767,-0.0157732077433538,-0.0165343454357570,-0.0171253388243203,-0.0175477517144632,-0.0178026645461269,-0.0178936246442981,-0.0178265699074701,-0.0176087274142592,-0.0172495359749771,-0.0167566526832823,-0.0161444427075606,-0.0154214061655387,-0.0146029440118744,-0.0137029815755800,-0.0127327050271981,-0.0117076450753931,-0.0106423573021051,-0.00955081270127063,-0.00844463927719365,-0.00733829839744072,-0.00624287483621639,-0.00517195565428610,-0.00413192937517582,-0.00313696282278568,-0.00219014191228400,-0.00130010802148164,-0.000478187296722703,0.000280981933850467,0.000967579829080463,0.00158151717594704,0.00211839498472640,0.00258422224047808,0.00297484232257631,0.00329693414236480,0.00354613163519810,0.00373502528613601,0.00385682559315105,0.00392689899373749,0.00395317904051374,0.00391185612453058,0.00384789398727738,0.00374564538082849,0.00361216177612001,0.00344709632934101,0.00326423094682146,0.00306488930435805,0.00285676006224006,0.00263856687971078,0.00241639010134931,0.00219049844531026,0.00196767992995259,0.00798012105183658};
float filter_taps_HP[] = {-0.0479639820732092,0.0129794775534695,0.0170671070587000,0.0222383658551426,0.0259827707896720,0.0255631804786344,0.0188881147359816,0.00493460510262979,-0.0163037636130214,-0.0432518414484733,-0.0729989797156793,-0.101970728706653,-0.126219050546337,-0.142354776197976,0.852011390963695,-0.142354776197976,-0.126219050546337,-0.101970728706653,-0.0729989797156793,-0.0432518414484733,-0.0163037636130214,0.00493460510262979,0.0188881147359816,0.0255631804786344,0.0259827707896720,0.0222383658551426,0.0170671070587000,0.0129794775534695,-0.0479639820732092};
float filter_taps_LP_72[] = {
		0.006960,
		0.004870,
		0.006450,
		0.008260,
		0.010291,
		0.012532,
		0.014961,
		0.017540,
		0.020242,
		0.023029,
		0.025833,
		0.028627,
		0.031341,
		0.033929,
		0.036335,
		0.038508,
		0.040398,
		0.041964,
		0.043171,
		0.043988,
		0.044403,
		0.044403,
		0.043988,
		0.043171,
		0.041964,
		0.040398,
		0.038508,
		0.036335,
		0.033929,
		0.031341,
		0.028627,
		0.025833,
		0.023029,
		0.020242,
		0.017540,
		0.014961,
		0.012532,
		0.010291,
		0.008260,
		0.006450,
		0.004870,
		0.006960};




float filter_taps_HP_72[] = {
		0.009902,
		0.073701,
		-0.000374,
		0.007143,
		0.001733,
		-0.003925,
		-0.011381,
		-0.020226,
		-0.029966,
		-0.040341,
		-0.050842,
		-0.060836,
		-0.069948,
		-0.077562,
		-0.083299,
		-0.086936,
		0.911918,
		-0.086936,
		-0.083299,
		-0.077562,
		-0.069948,
		-0.060836,
		-0.050842,
		-0.040341,
		-0.029966,
		-0.020226,
		-0.011381,
		-0.003925,
		0.001733,
		0.007143,
		-0.000374,
		0.073701,
		0.009902};

float outputOfFIR;



void checkIndex(int currentIndex, int filterType) {
	currentIndex %=filterType;
}

int main(void) {

	DisableDog();
	InitPll(10,3);
	analogToDigitalConverter_init();
	//Sram_init();
	digitalToAnalogConverter_init();
	timer_init(150.0,13.6757);
	enable_timer_interrupt();
	EALLOW;
	useGpio();


	//TODO: finish the inits and run this code

	while(1) {
		EALLOW;
		//digitalToAnalogConverter_send(analogToDigitalConverter_send());

		//TODO: fix this or remove comment to check performance
		//while(!interruptTimerFlag);

		outputOfFIR = 0;
		bufferForFilters[j] = (((float)analogToDigitalConverter_send())- 0x7FFF); // change the internal offset by making the read value a signed number
		EALLOW;
		GpioDataRegs.GPADAT.bit.GPIO0 = 0;
		for (int i = 0; i < FILTER_HP_72K; i++) {
				outputOfFIR += filter_taps_HP_72[i]*bufferForFilters[(j-i) & (0x00FF)];
		}
		outputOfFIR = (outputOfFIR + 0x7FFF); // change back to manage the offset
		GpioDataRegs.GPADAT.bit.GPIO0 = 1;
		digitalToAnalogConverter_send((Uint16)outputOfFIR);
		j = (j + 1) & (0x00FF);
		EALLOW;

		interruptTimerFlag = 0;

	}
	//return 0;
}
